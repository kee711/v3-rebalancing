
  ---
  목차

  1. #1-v3-concentrated-liquidity-수학
  2. #2-거래량-기반-fee-계산
  3. #3-유동성-점유율-모델
  4. #4-슬리피지-모델
  5. #5-mev샌드위치-비용
  6. #6-가스비-변동성
  7. #7-리밸런싱-전략에-미치는-영향

  ---
  1. V3 Concentrated Liquidity 수학

  기존 문제점

  // 기존 코드: 단순화된 가정
  vault.position.liquidityUsd *= 1 + priceReturn / 2;

  // 예: 가격이 10% 상승하면 포지션 가치는 5% 상승한다고 가정

  왜 틀렸나?

  V2 (Uniswap V2)에서는 이 근사치가 어느 정도 맞았습니다. 하지만 V3는 **집중
  유동성(Concentrated Liquidity)**을 사용합니다.

  V2 vs V3 차이점

  ┌─────────────────────────────────────────────────────────────┐
  │                    Uniswap V2 (x * y = k)                   │
  │                                                             │
  │  $0 ─────────────────●─────────────────────────── $∞        │
  │      유동성이 전체 가격대에 균일하게 분포                    │
  │      → 자본 효율성 낮음 (대부분의 유동성이 사용 안 됨)       │
  └─────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────┐
  │                    Uniswap V3 (Concentrated)                │
  │                                                             │
  │  $0 ─────────────[████████]───────────────────── $∞         │
  │                  $1700   $1900                              │
  │      유동성을 특정 가격대에 집중                             │
  │      → 자본 효율성 높음 (적은 자본으로 더 많은 fee)         │
  └─────────────────────────────────────────────────────────────┘

  실제 V3 수학

  V3에서 포지션의 구성은 현재 가격 위치에 따라 완전히 달라집니다:

  가격 위치에 따른 포지션 구성:

  ┌─────────────────────────────────────────────────────────────┐
  │                                                             │
  │  가격 < Lower (Range 아래)                                  │
  │  ┌────────────────┐                                        │
  │  │ 100% Base (ETH)│  ← 모든 자산이 ETH로 변환됨            │
  │  │   0% Quote ($) │                                        │
  │  └────────────────┘                                        │
  │                                                             │
  │  Lower < 가격 < Upper (Range 안)                            │
  │  ┌────────────────┐                                        │
  │  │  ~50% Base     │  ← ETH와 USDC 혼합                     │
  │  │  ~50% Quote    │    (정확한 비율은 가격 위치에 따라)     │
  │  └────────────────┘                                        │
  │                                                             │
  │  가격 > Upper (Range 위)                                    │
  │  ┌────────────────┐                                        │
  │  │   0% Base (ETH)│  ← 모든 자산이 USDC로 변환됨           │
  │  │ 100% Quote ($) │                                        │
  │  └────────────────┘                                        │
  └─────────────────────────────────────────────────────────────┘

  실제 예시: ETH/USDC 포지션

  초기 상태:
  - Range: $1,700 ~ $1,900
  - 현재 가격: $1,800
  - 예치 금액: $10,000 (5 ETH + $1,000 USDC 정도)

  시나리오 A: 가격이 $1,800 → $1,600 하락 (Range 이탈)

    기존 모델:
      포지션 가치 = $10,000 × (1 + (-11%)/2) = $9,450
      구성 = 여전히 50:50 가정

    실제 V3:
      포지션 가치 = 약 $8,500 (더 큰 손실!)
      구성 = 100% ETH, 0% USDC

      왜? 가격이 하락하면서:
      1. USDC가 모두 ETH로 스왑됨
      2. ETH 수량 증가 (예: 5 ETH → 6.25 ETH)
      3. 하지만 ETH 가격 하락으로 총 가치 감소
      4. 이것이 "Impermanent Loss"

  우리가 구현한 코드

  // v3math.ts - 실제 V3 수학 공식

  export function getAmountsForLiquidity(
    liquidity: number,  // L: 유동성 상수
    lower: number,      // 하한 가격
    upper: number,      // 상한 가격
    price: number       // 현재 가격
  ): { baseAmount: number; quoteAmount: number } {

    const sqrtLower = Math.sqrt(lower);
    const sqrtUpper = Math.sqrt(upper);
    const sqrtPrice = Math.sqrt(price);

    if (price <= lower) {
      // Range 아래: 100% Base
      baseAmount = liquidity * (1/sqrtLower - 1/sqrtUpper);
      quoteAmount = 0;
    }
    else if (price >= upper) {
      // Range 위: 100% Quote
      baseAmount = 0;
      quoteAmount = liquidity * (sqrtUpper - sqrtLower);
    }
    else {
      // Range 안: 혼합
      baseAmount = liquidity * (1/sqrtPrice - 1/sqrtUpper);
      quoteAmount = liquidity * (sqrtPrice - sqrtLower);
    }
  }

  리밸런싱 전략에 미치는 영향
  ┌──────────────┬─────────────┬────────────────────┬──────────────────────────┐
  │     상황     │  기존 모델  │      실제 V3       │       전략적 의미        │
  ├──────────────┼─────────────┼────────────────────┼──────────────────────────┤
  │ 가격 10%     │ -5% 손실    │ -8~15% 손실        │ IL이 과소평가되고 있었음 │
  │ 하락         │             │                    │                          │
  ├──────────────┼─────────────┼────────────────────┼──────────────────────────┤
  │ Range 이탈   │ 여전히      │ 100:0 또는 0:100   │ 리밸런싱 시 swap 필요    │
  │              │ 50:50       │                    │                          │
  ├──────────────┼─────────────┼────────────────────┼──────────────────────────┤
  │ 포지션 인출  │ 예상 금액   │ 실제 토큰 비율     │ 인출 시기가 수익에 큰    │
  │              │             │ 반영               │ 영향                     │
  └──────────────┴─────────────┴────────────────────┴──────────────────────────┘
  핵심 인사이트:
  "V3에서 리밸런싱을 미루면 IL이 기하급수적으로 증가할 수 있다. 하지만 너무 자
   리밸런싱하면 거래 비용이 IL보다 커진다."

  ---
  2. 거래량 기반 Fee 계산

  기존 문제점

  // 기존: 고정 APR 사용
  const feesApr = 0.22; // 22% 연간 수익률 가정
  const fees = positionValue * feesApr * (days / 365);

  왜 틀렸나?

  Fee 수입은 거래량에서 발생합니다. 거래량이 없으면 fee도 없습니다!

  실제 Fee 발생 메커니즘

  ┌─────────────────────────────────────────────────────────────┐
  │                    Fee 발생 과정                            │
  ├─────────────────────────────────────────────────────────────┤
  │                                                             │
  │  1. 누군가 ETH → USDC 스왑 ($10,000)                       │
  │                    ↓                                        │
  │  2. 스왑 수수료 발생: $10,000 × 0.3% = $30                  │
  │                    ↓                                        │
  │  3. $30이 해당 가격대의 LP들에게 분배                       │
  │                    ↓                                        │
  │  4. 내 점유율만큼 수령 (예: 1% → $0.30)                     │
  │                                                             │
  └─────────────────────────────────────────────────────────────┘

  거래량과 변동성의 관계

  ┌─────────────────────────────────────────────────────────────┐
  │           Price vs Volume Correlation                       │
  │                                                             │
  │  가격 │    ╱╲                                               │
  │       │   ╱  ╲      ╱╲                                      │
  │       │  ╱    ╲    ╱  ╲                                     │
  │       │ ╱      ╲  ╱    ╲                                    │
  │       │╱        ╲╱      ╲                                   │
  │       └─────────────────────→ 시간                          │
  │                                                             │
  │  거래량│    █                                                │
  │       │   ███     █                                         │
  │       │  █████   ███                                        │
  │       │ ███████ █████                                       │
  │       │█████████████████                                    │
  │       └─────────────────────→ 시간                          │
  │                                                             │
  │  ※ 가격이 급변할 때 거래량이 급증!                          │
  └─────────────────────────────────────────────────────────────┘

  시장 상황별 Fee 수입 차이
  ┌──────────────────────┬───────────┬───────────────┬──────────┐
  │      시장 상황       │  거래량   │ 고정 APR 가정 │ 실제 Fee │
  ├──────────────────────┼───────────┼───────────────┼──────────┤
  │ 횡보장 (지루한 시장) │ 낮음      │ 22%           │ 5-10%    │
  ├──────────────────────┼───────────┼───────────────┼──────────┤
  │ 급등/급락 (뉴스)     │ 매우 높음 │ 22%           │ 50-100%+ │
  ├──────────────────────┼───────────┼───────────────┼──────────┤
  │ 일반적인 변동        │ 보통      │ 22%           │ 15-30%   │
  └──────────────────────┴───────────┴───────────────┴──────────┘
  우리가 구현한 코드

  // sample.ts - 거래량 기반 Fee 계산

  function calculateVolume(priceReturn, baseVolume, volMultiplier, rng) {
    // 가격 변화가 클수록 거래량 증가
    const absReturn = Math.abs(priceReturn);
    const volMultiplier = 1 + absReturn * 50; // 1% 가격변동 → 1.5x 거래량

    return baseVolume * volMultiplier * noise;
  }

  // Fee APR = 거래량 × Fee Tier / TVL × 연환산
  const feesApr = (volumeUsd * feeTier * 365 * 24) / (tvl * hoursPerStep);

  리밸런싱 전략에 미치는 영향

  핵심 인사이트:
  "변동성이 높을 때 Fee 수입도 높다. 하지만 변동성이 높을 때 Range 이탈 확률도
  높다!"

  ┌─────────────────────────────────────────────────────────────┐
  │                    전략적 딜레마                             │
  ├─────────────────────────────────────────────────────────────┤
  │                                                             │
  │  변동성 ↑ → Fee ↑ (좋음!) + Range 이탈 확률 ↑ (나쁨!)      │
  │                                                             │
  │  해결책:                                                    │
  │  1. 변동성에 따라 Range 폭 동적 조절                        │
  │  2. 변동성 높을 때 = 넓은 Range (안정성 우선)               │
  │  3. 변동성 낮을 때 = 좁은 Range (수익성 우선)               │
  │                                                             │
  └─────────────────────────────────────────────────────────────┘

  ---
  3. 유동성 점유율 모델

  기존 문제점

  // 기존: 전체 TVL 대비 비율로 계산
  const myShare = myPositionValue / totalPoolTVL;
  const myFees = totalPoolFees * myShare;

  // 예: $10,000 / $10,000,000 = 0.1% → 전체 fee의 0.1%

  왜 틀렸나?

  V3에서는 같은 금액이라도 Range가 좁으면 더 많은 fee를 받습니다!

  V3 유동성 집중의 마법

  ┌─────────────────────────────────────────────────────────────┐
  │            같은 $10,000로 다른 전략 비교                     │
  ├─────────────────────────────────────────────────────────────┤
  │                                                             │
  │  LP A: Wide Range ($1,500 - $2,100) = 40% 폭                │
  │  ┌──────────[████████████████████████████]──────────┐       │
  │  │          $1,500              $2,100              │       │
  │  │  유동성 집중도: 1x (기준)                         │       │
  │  │  Fee 점유율: 0.1%                                │       │
  │  └──────────────────────────────────────────────────┘       │
  │                                                             │
  │  LP B: Narrow Range ($1,700 - $1,900) = 11% 폭              │
  │  ┌──────────────────[████████]──────────────────────┐       │
  │  │                  $1,700  $1,900                  │       │
  │  │  유동성 집중도: 3.6x (40%/11%)                   │       │
  │  │  Fee 점유율: 0.36% (3.6배!)                      │       │
  │  └──────────────────────────────────────────────────┘       │
  │                                                             │
  │  ※ 같은 $10,000인데 LP B가 3.6배 더 많은 fee 획득!         │
  │  ※ 단, LP B는 Range 이탈 시 fee = 0                        │
  └─────────────────────────────────────────────────────────────┘

  집중도 계산 공식

  // 유동성 집중도 = sqrt(현재가격) / (sqrt(상한) - sqrt(하한))

  function getLiquidityConcentration(lower, upper, price) {
    const sqrtPrice = Math.sqrt(price);
    const rangeWidth = Math.sqrt(upper) - Math.sqrt(lower);

    return sqrtPrice / rangeWidth;
  }

  // 예시:
  // Wide ($1,500-$2,100): sqrt(1800) / (sqrt(2100) - sqrt(1500)) = 42.4 / 7.1 =
   5.97
  // Narrow ($1,700-$1,900): sqrt(1800) / (sqrt(1900) - sqrt(1700)) = 42.4 /
  1.97 = 21.5

  // 집중도 비율: 21.5 / 5.97 = 3.6x

  실제 Fee 분배 계산

  function calculateFeeShare(myLiquidity, lower, upper, poolTvl, price) {
    // 1. 내 포지션 가치 계산
    const myValue = getPositionValueUsd(myLiquidity, lower, upper, price);

    // 2. 내 집중도 계산
    const myConcentration = getLiquidityConcentration(lower, upper, price);

    // 3. 평균 LP 집중도 가정 (보통 20% Range)
    const avgConcentration = getLiquidityConcentration(
      price * 0.8,  // -20%
      price * 1.2,  // +20%
      price
    );

    // 4. 기본 점유율 × 집중도 비율
    const baseShare = myValue / poolTvl;
    const concentrationBonus = myConcentration / avgConcentration;

    return baseShare * concentrationBonus;
  }

  리밸런싱 전략에 미치는 영향

  ┌─────────────────────────────────────────────────────────────┐
  │              Range 폭에 따른 Trade-off                      │
  ├─────────────────────────────────────────────────────────────┤
  │                                                             │
  │  Range 폭    │  Fee 집중도  │  이탈 확률  │  리밸런싱 빈도   │
  │  ───────────│─────────────│────────────│─────────────────  │
  │  ±5%        │  10x        │  매우 높음  │  하루 수십 번     │
  │  ±10%       │  5x         │  높음      │  하루 수 번       │
  │  ±20%       │  2.5x       │  보통      │  며칠에 한 번     │
  │  ±50%       │  1x         │  낮음      │  거의 없음        │
  │                                                             │
  │  ※ 리밸런싱 비용 (Gas + MEV)이 집중도 이익보다 클 수 있음!  │
  └─────────────────────────────────────────────────────────────┘

  핵심 인사이트:
  "좁은 Range = 높은 Fee but 높은 리밸런싱 비용. 최적 Range는 변동성과 거래
  비용의 함수다."

  ---
  4. 슬리피지 모델

  슬리피지란?

  ┌─────────────────────────────────────────────────────────────┐
  │                    슬리피지 발생 원인                        │
  ├─────────────────────────────────────────────────────────────┤
  │                                                             │
  │  당신이 보는 가격: $1,800.00 (mid-price)                    │
  │                                                             │
  │  실제 거래 가격:                                            │
  │  ┌────────────────────────────────────────┐                │
  │  │  매수 시: $1,800.90 (0.05% 더 비쌈)    │ ← Ask Price    │
  │  │  매도 시: $1,799.10 (0.05% 더 쌈)      │ ← Bid Price    │
  │  └────────────────────────────────────────┘                │
  │                       ↑                                     │
  │              Bid-Ask Spread (0.1%)                          │
  │                                                             │
  │  + Price Impact (거래 규모에 따른 추가 손실)                │
  │                                                             │
  └─────────────────────────────────────────────────────────────┘

  Price Impact 시각화

  ┌─────────────────────────────────────────────────────────────┐
  │                    Price Impact Curve                       │
  │                                                             │
  │  실제 체결가격                                               │
  │       │                                                     │
  │       │                                    ╱ 대형 거래      │
  │       │                               ╱                     │
  │       │                          ╱                          │
  │       │                     ╱                               │
  │       │                ╱   ← 중형 거래                      │
  │       │           ╱                                         │
  │       │      ╱    ← 소형 거래                               │
  │       │ ╱                                                   │
  │       └─────────────────────────────────────→ 거래 규모     │
  │                                                             │
  │  $100 거래: ~0.1% 손실                                      │
  │  $10,000 거래: ~0.5% 손실                                   │
  │  $100,000 거래: ~2-5% 손실                                  │
  └─────────────────────────────────────────────────────────────┘

  우리가 구현한 코드

  function getEffectiveSwapPrice(
    midPrice: number,
    tradeValueUsd: number,
    poolLiquidityUsd: number,
    isBuy: boolean,        // true = 매수, false = 매도
    spreadBps: number,     // Bid-Ask Spread (basis points)
    impactBps: number      // Price Impact 계수
  ) {
    // 1. Spread 비용: 항상 발생
    const spreadFactor = spreadBps / 10000; // 10bps = 0.1%

    // 2. Price Impact: 거래 규모에 비례
    const tradeRatio = tradeValueUsd / poolLiquidityUsd;
    const impactFactor = (impactBps / 10000) * (tradeRatio * 100);

    // 3. 최종 가격
    if (isBuy) {
      // 매수: 더 비싸게 삼
      return midPrice * (1 + spreadFactor/2 + impactFactor);
    } else {
      // 매도: 더 싸게 팔림
      return midPrice * (1 - spreadFactor/2 - impactFactor);
    }
  }

  실제 예시

  $10,000 ETH 매도 시나리오:
  - Mid Price: $1,800
  - Pool TVL: $25,000,000
  - Spread: 10bps (0.1%)
  - Impact: 5bps per 1% of pool

  계산:
  1. Spread 손실: $10,000 × 0.05% = $5
  2. Trade Ratio: $10,000 / $25,000,000 = 0.04%
  3. Impact 손실: $10,000 × (0.04% × 5) = $2
  4. 총 슬리피지: $7 (0.07%)

  실제 수령액: $10,000 - $7 = $9,993

  리밸런싱 전략에 미치는 영향
  ┌───────────────┬─────────────┬──────────────┐
  │ 리밸런싱 규모 │  슬리피지   │ 1년 100회 시 │
  ├───────────────┼─────────────┼──────────────┤
  │ $1,000        │ ~$1 (0.1%)  │ $100 손실    │
  ├───────────────┼─────────────┼──────────────┤
  │ $10,000       │ ~$7 (0.07%) │ $700 손실    │
  ├───────────────┼─────────────┼──────────────┤
  │ $50,000       │ ~$50 (0.1%) │ $5,000 손실  │
  └───────────────┴─────────────┴──────────────┘
  핵심 인사이트:
  "작은 금액을 자주 리밸런싱하면 슬리피지 %는 비슷하지만 절대 금액은 적다. 큰
  금액을 한 번에 리밸런싱하면 Price Impact가 크다."

  ---
  5. MEV/샌드위치 비용

  MEV (Maximal Extractable Value)란?

  블록을 생성하는 사람(또는 봇)이 트랜잭션 순서를 조작하여 이익을 추출하는 것.

  샌드위치 공격 시각화

  ┌─────────────────────────────────────────────────────────────┐
  │                    Sandwich Attack                          │
  ├─────────────────────────────────────────────────────────────┤
  │                                                             │
  │  시간 →                                                     │
  │                                                             │
  │  ┌─────┐                                                    │
  │  │ TX1 │ MEV 봇: ETH 매도 (가격 하락 유발)                  │
  │  └──┬──┘                                                    │
  │     ↓                                                       │
  │  ┌─────┐                                                    │
  │  │ TX2 │ 당신: ETH 매도 (불리한 가격에 체결!)               │
  │  └──┬──┘                                                    │
  │     ↓                                                       │
  │  ┌─────┐                                                    │
  │  │ TX3 │ MEV 봇: ETH 매수 (차익 실현)                       │
  │  └─────┘                                                    │
  │                                                             │
  │  가격 변화:                                                 │
  │  $1,800 → $1,795 (TX1) → $1,790 (TX2) → $1,795 (TX3)       │
  │                    ↑                                        │
  │           당신의 손실 = 봇의 이익                            │
  └─────────────────────────────────────────────────────────────┘

  실제 예시

  당신의 리밸런싱 TX: $10,000 ETH → USDC

  1. 당신의 TX가 mempool에 공개됨
  2. MEV 봇이 감지

  봇의 행동:
    TX1: 봇이 먼저 $50,000 ETH 매도
         → 가격: $1,800 → $1,795

    TX2: 당신의 TX 실행
         → 예상 수령: $10,000 × $1,800 = $18,000
         → 실제 수령: $10,000 × $1,795 = $17,950
         → 손실: $50

    TX3: 봇이 $50,000 ETH 매수
         → 가격: $1,795 → $1,800
         → 봇 이익: ~$50 (수수료 제외)

  MEV 비용에 영향을 주는 요소

  ┌─────────────────────────────────────────────────────────────┐
  │                    MEV 비용 결정 요소                        │
  ├─────────────────────────────────────────────────────────────┤
  │                                                             │
  │  1. 거래 규모 ↑ → MEV 비용 ↑                               │
  │     - 큰 거래 = 봇에게 더 큰 이익 기회                       │
  │                                                             │
  │  2. 시장 변동성 ↑ → MEV 비용 ↑                             │
  │     - 변동성 높을 때 봇 활동 증가                            │
  │                                                             │
  │  3. 풀 유동성 ↓ → MEV 비용 ↑                               │
  │     - 유동성 적으면 가격 조작 쉬움                           │
  │                                                             │
  │  4. 보호 수단:                                              │
  │     - Flashbots: Private mempool 사용                       │
  │     - MEV Blocker: TX를 숨김                                │
  │     - 낮은 슬리피지 허용치: 봇 이익 최소화                   │
  │                                                             │
  └─────────────────────────────────────────────────────────────┘

  우리가 구현한 코드

  function estimateMevCost(
    tradeValueUsd: number,
    poolLiquidityUsd: number,
    volatility: number,
    baseMevBps: number = 15  // 기본 0.15%
  ) {
    // 거래 규모 factor (로그 스케일)
    const tradeRatio = tradeValueUsd / poolLiquidityUsd;
    const sizeFactor = 1 + Math.log10(1 + tradeRatio * 100);

    // 변동성 factor
    const volFactor = Math.max(0.5, volatility / 0.5);

    // 소액 거래 할인 ($500 미만은 봇이 관심 없음)
    const smallTradeDiscount = tradeValueUsd < 500
      ? tradeValueUsd / 500
      : 1;

    const mevRate = (baseMevBps / 10000) * sizeFactor * volFactor *
  smallTradeDiscount;

    return tradeValueUsd * mevRate;
  }

  리밸런싱 전략에 미치는 영향

  ┌─────────────────────────────────────────────────────────────┐
  │              MEV와 리밸런싱 빈도의 관계                      │
  ├─────────────────────────────────────────────────────────────┤
  │                                                             │
  │  연간 리밸런싱 │  거래당 MEV  │  연간 MEV 손실              │
  │  ────────────│────────────│──────────────────            │
  │  12회 (월 1)  │  ~$25      │  $300                        │
  │  52회 (주 1)  │  ~$25      │  $1,300                      │
  │  365회 (일 1) │  ~$25      │  $9,125                      │
  │  1,000회+     │  ~$25      │  $25,000+  ← 자본 잠식!      │
  │                                                             │
  │  ※ $10,000 자본 기준, 연간 MEV만으로 자본의 250% 손실 가능  │
  └─────────────────────────────────────────────────────────────┘

  핵심 인사이트:
  "MEV는 '숨겨진 세금'이다. 보이지 않지만 매 거래마다 0.1-0.5%씩 빠져나간다.
  연간 수백 번 리밸런싱하면 이 비용이 수익을 압도한다."

  ---
  6. 가스비 변동성

  가스비 변동 패턴

  ┌─────────────────────────────────────────────────────────────┐
  │                 Ethereum Gas Price (24h)                    │
  ├─────────────────────────────────────────────────────────────┤
  │                                                             │
  │  Gwei                                                       │
  │  100 │                         ●●                           │
  │      │                        ●  ●     ● NFT Drop!          │
  │   50 │        ●●●●           ●    ●   ●                     │
  │      │    ●●●    ●●●       ●      ●●●                       │
  │   20 │●●●          ●●●●●●●                                  │
  │      └──────────────────────────────────────────────→       │
  │       0:00  6:00  12:00  18:00  0:00  (UTC)                 │
  │         ↑           ↑      ↑                                │
  │       아시아      유럽    미국 (피크)                        │
  │                                                             │
  └─────────────────────────────────────────────────────────────┘

  L1 vs L2 가스비 비교
  ┌─────────────┬─────────────┬────────┬────────────┐
  │    체인     │ 평균 가스비 │ 변동성 │  스파이크  │
  ├─────────────┼─────────────┼────────┼────────────┤
  │ Ethereum L1 │ $5-50       │ 높음   │ $100+ 가능 │
  ├─────────────┼─────────────┼────────┼────────────┤
  │ Arbitrum    │ $0.10-0.50  │ 중간   │ $2 이하    │
  ├─────────────┼─────────────┼────────┼────────────┤
  │ Base        │ $0.05-0.30  │ 낮음   │ $1 이하    │
  ├─────────────┼─────────────┼────────┼────────────┤
  │ Optimism    │ $0.10-0.50  │ 중간   │ $2 이하    │
  └─────────────┴─────────────┴────────┴────────────┘
  우리가 구현한 코드

  function calculateGasPrice(
    baseGasUsd: number,
    timestampMs: number,
    priceVolatility: number,
    isL2: boolean,
    rng: SeededRng
  ) {
    // 1. 시간대 factor
    const hour = new Date(timestampMs).getUTCHours();
    let timeFactor: number;

    if (hour >= 14 && hour <= 22) {
      timeFactor = 1.3 + rng.next() * 0.4; // US hours: 1.3-1.7x
    } else if (hour >= 6 && hour <= 14) {
      timeFactor = 1.0 + rng.next() * 0.3; // EU hours: 1.0-1.3x
    } else {
      timeFactor = 0.7 + rng.next() * 0.3; // Off-peak: 0.7-1.0x
    }

    // 2. 변동성 factor (시장 급변 시 가스비 급등)
    const volFactor = 1 + priceVolatility * 2;

    // 3. 랜덤 스파이크 (5% 확률로 2-5x)
    const spikeFactor = rng.next() < 0.05
      ? 2 + rng.next() * 3
      : 1;

    // 4. L2 할인 (L2는 70% 저렴)
    const l2Discount = isL2 ? 0.3 : 1.0;

    return baseGasUsd * timeFactor * volFactor * spikeFactor * l2Discount;
  }

  리밸런싱 전략에 미치는 영향

  ┌─────────────────────────────────────────────────────────────┐
  │              가스비 최적화 전략                              │
  ├─────────────────────────────────────────────────────────────┤
  │                                                             │
  │  1. 시간대 선택                                             │
  │     ✓ UTC 0-6시 (미국 새벽) = 가장 저렴                     │
  │     ✗ UTC 18-22시 (미국 오후) = 가장 비쌈                   │
  │                                                             │
  │  2. 급한 리밸런싱 vs 대기                                    │
  │     - Range 살짝 이탈 → 가스비 낮을 때까지 대기              │
  │     - Range 크게 이탈 → 즉시 리밸런싱 (IL 손실 > 가스비)     │
  │                                                             │
  │  3. L2 선택                                                 │
  │     - 잦은 리밸런싱 필요 → Base, Arbitrum 추천              │
  │     - L1 대비 70%+ 가스비 절감                              │
  │                                                             │
  │  4. 배치 처리                                               │
  │     - 여러 작업을 한 TX에 묶기                               │
  │     - 예: Remove + Swap + Add를 multicall로                 │
  │                                                             │
  └─────────────────────────────────────────────────────────────┘

  핵심 인사이트:
  "L2에서 운영하면 가스비가 1/3로 줄어 리밸런싱 빈도를 3배로 늘릴 수 있다. 같은
  전략이라도 체인 선택에 따라 수익률이 크게 달라진다."

  ---
  7. 리밸런싱 전략에 미치는 영향 종합

  모든 비용 요소 합산

  ┌─────────────────────────────────────────────────────────────┐
  │              리밸런싱 1회당 총 비용 (예시)                   │
  ├─────────────────────────────────────────────────────────────┤
  │                                                             │
  │  거래 금액: $10,000                                         │
  │                                                             │
  │  ┌────────────────────────────────────────────────┐        │
  │  │ 비용 항목        │   L1      │    L2           │        │
  │  │─────────────────│──────────│────────────────│        │
  │  │ 가스비           │  $15     │    $0.50       │        │
  │  │ 슬리피지         │  $7      │    $7          │        │
  │  │ MEV             │  $25     │    $10 (낮음)   │        │
  │  │─────────────────│──────────│────────────────│        │
  │  │ 총 비용          │  $47     │    $17.50      │        │
  │  │ 비용률           │  0.47%   │    0.175%      │        │
  │  └────────────────────────────────────────────────┘        │
  │                                                             │
  │  연간 100회 리밸런싱 시:                                     │
  │  - L1: $4,700 비용 (47% of capital!)                       │
  │  - L2: $1,750 비용 (17.5% of capital)                      │
  │                                                             │
  └─────────────────────────────────────────────────────────────┘

  최적 리밸런싱 공식

  리밸런싱 해야 할 때:

    예상 Fee 수입 × 예상 in-range 시간
    ─────────────────────────────────  >  안전 마진 (예: 1.5x)
       Gas + Slippage + MEV

  예시:
    - 예상 Fee: 일 $50
    - 예상 in-range: 3일
    - 총 예상 수입: $150

    - Gas: $0.50
    - Slippage: $7
    - MEV: $10
    - 총 비용: $17.50

    $150 / $17.50 = 8.6x > 1.5x ✓ → 리밸런싱 OK!

  전략 최적화 체크리스트

  ┌─────────────────────────────────────────────────────────────┐
  │              효율적인 리밸런싱을 위한 체크리스트             │
  ├─────────────────────────────────────────────────────────────┤
  │                                                             │
  │  □ 체인 선택                                                │
  │    - L2 사용 (Base, Arbitrum) → 가스비 70%↓                │
  │                                                             │
  │  □ MEV 보호                                                 │
  │    - Flashbots/MEV Blocker 사용 → MEV 비용 50-90%↓         │
  │                                                             │
  │  □ Range 폭 최적화                                          │
  │    - 변동성 높을 때: 넓은 Range (±15-20%)                   │
  │    - 변동성 낮을 때: 좁은 Range (±5-10%)                    │
  │                                                             │
  │  □ 리밸런싱 타이밍                                          │
  │    - UTC 0-6시 실행 → 가스비 30%↓                          │
  │    - 급하지 않으면 가스비 낮을 때까지 대기                   │
  │                                                             │
  │  □ 임계값 설정                                              │
  │    - 예상 수익 > 비용 × 1.5 일 때만 리밸런싱                │
  │    - 너무 자주 리밸런싱 X (비용 누적)                        │
  │    - 너무 드물게 X (IL 누적)                                │
  │                                                             │
  │  □ 모니터링                                                 │
  │    - 실제 Fee APR 추적 (예상과 비교)                        │
  │    - 실제 비용 추적 (Gas + Slippage + MEV)                  │
  │    - Time-in-range 추적 (목표 vs 실제)                      │
  │                                                             │
  └─────────────────────────────────────────────────────────────┘

  핵심 요약

  ┌─────────────────────────────────────────────────────────────┐
  │                    핵심 인사이트 요약                        │
  ├─────────────────────────────────────────────────────────────┤
  │                                                             │
  │  1. V3 수학: IL이 기존 모델보다 훨씬 크다                    │
  │                                                             │
  │  2. Fee는 거래량 함수: 횡보장 = 낮은 수입                    │
  │                                                             │
  │  3. 집중도 = 양날의 검: 높은 Fee but 높은 리스크             │
  │                                                             │
  │  4. 숨겨진 비용 (MEV + Slippage)이 수익을 잠식               │
  │                                                             │
  │  5. 체인 선택이 수익률을 결정 (L2 >> L1)                    │
  │                                                             │
  │  6. 최적 전략 = 비용 최소화 + 수익 최대화의 균형             │
  │                                                             │
  │  ※ 백테스팅 없이 전략 운영 = 눈 감고 운전                   │
  │                                                             │
  └─────────────────────────────────────────────────────────────┘

  ---
  이 내용으로 다른 사람에게 설명할 수 있을 것입니다. 추가로 궁금한 부분이 있으
   말씀해주세요!
